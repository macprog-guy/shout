'use strict'

/*

 Benchmarks

 The goal of these small benchmarks is to evaluate the overhead generated by
 the use of our "publish/subscribe" library as opposed to having objects 
 notify observers directly.
 
*/

const Benchmarkify = require('benchmarkify'),
      benchmark    = new Benchmarkify("ShoutJS").printHeader(),
      Shout        = require('../index.js')

const bench = benchmark.createSuite("Asynchronous cases")


const identityWare = (payload, meta, next) => { next(payload, meta) }


// ------------------------------------------------------------------------
//
// Object Notification
//
// NOTE: we use a plain for loop just like in our optimized code because
//       using a for-of loop reduced raw performance.
//
// ------------------------------------------------------------------------

function notify() {
  
  const o = this.observers,
        n = o.length,
        v = this.value

  for (let i=0;  i<n;  i++)
    setTimeout(() => {  o[i](this, v) }, 0)
}

const object = { value: 1 }
object.observers = [() => {}]
object.notify = notify.bind(object) 


bench.add('Direct observer callback', () => {
  object.notify()
})


// ------------------------------------------------------------------------
//
// Publishing to the root topic with one subscriber
//
// ------------------------------------------------------------------------

const topics1 = Shout()
topics1.subscribe(() => {})

bench.add('Publish to the root topic with one subscriber', () => {
  topics1.publishAsync('hello')
})


// ------------------------------------------------------------------------
//
// Publishing to a nested topic with one subscriber
//
// ------------------------------------------------------------------------

const topics2   = Shout(),
      subtopic2 = topics2('foo.bar.baz').subscribe(() => {})

bench.add('Publishing to a nested topic with one subscriber', () => {
  subtopic2.publishAsync('hello')
})


// ------------------------------------------------------------------------
//
// Publishing to a nested topic with subscribers on topic chain
//
// ------------------------------------------------------------------------

const topics3   = Shout(),
      subtopic3 = topics3('foo')
                    .subscribe(() => {})
                    .subtopic('bar')
                      .subscribe(() => {})
                      .subtopic('baz')
                        .subscribe(() => {})

bench.add('Publishing to a nested topic with subscribers on topic chain', () => {
  subtopic3.publishAsync('hello')
})


// ------------------------------------------------------------------------
//
// Publishing to a nested topic with subscribers all along the topic chain
// and a middleware function at each level also
//
// ------------------------------------------------------------------------

const topics4   = Shout(),
      subtopic4 = topics3('foo')
                    .use(identityWare)
                    .subscribe(() => {})
                    .subtopic('bar')
                      .use(identityWare)
                      .subscribe(() => {})
                      .subtopic('baz')
                        .use(identityWare)
                        .subscribe(() => {})

bench.add('Publishing to a nested topic with subscribers and middleware on topic chain', () => {
  subtopic4.publishAsync('hello')
})



bench.run()

